- name: Check if Nix is installed
  stat: path=/nix/store
  register: nix_installed

- name: Install expect
  pacman:
    name: expect
    state: present
  when: is_arch and not nix_installed.stat.exists

- name: Download Nix install script
  get_url:
    url: https://nixos.org/nix/install
    dest: /tmp/nix-install.sh
    mode: '0755'
  when: not nix_installed.stat.exists

- name: Create expect script for Nix installation
  copy:
    content: |
      #!/usr/bin/expect -f
      set timeout -1
      spawn sh /tmp/nix-install.sh --daemon --no-channel-add
      expect {
        "Press ENTER to continue" { send "\r"; exp_continue }
        "Would you like to proceed?" { send "y\r"; exp_continue }
        "Do you want Nix to create a system-wide daemon?" { send "y\r"; exp_continue }
        "Would you like to add a line to your.*" { send "y\r"; exp_continue }
        "Would you like Nix to automatically manage your shell profile?" { send "y\r"; exp_continue }
        "(Y/n)" { send "Y\r"; exp_continue }
        "(y/N)" { send "y\r"; exp_continue }
        eof
      }
    dest: /tmp/nix-install-expect.exp
    mode: '0755'
  when: not nix_installed.stat.exists

- name: Run Nix installation script with expect
  command: /tmp/nix-install-expect.exp
  args:
    creates: /nix/store
  register: nix_install
  when: not nix_installed.stat.exists

